<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBook - Giỏ hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/42.0.1/ckeditor5.css">
    <script src="https://kit.fontawesome.com/ad778f42b3.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./css/common.css">
    <style>
        body {
            background-color: #f8f9fa;
            color: #212529;
        }
        .cart-container {
            padding: 20px;
        }
        .cart-header, .cart-footer {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .cart-table th, .cart-table td {
            vertical-align: middle;
            text-align: center;
        }
        .cart-table img {
            width: 100px;
            height: auto;
        }
        .quantity-input {
            width: 60px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row" style="background-color: crimson;">
            <div class="col-lg-12">
                <div class="d-flex">
                    <div class="col-lg-3">
                        <a href="./"><img src="./images/ebook-logo.png" alt="EBook Store" width="100%" /></a>
                    </div>


                    <div class="col-lg-6 d-flex align-items-center position-relative">
                        <div class="d-flex justify-content-around align-items-center flex-fill">
                            <div class="dropdownContainer">
                                <i class="fa-solid fa-square-poll-horizontal text-white fa-2x crs"></i>
                                <div class="dropdownContent">
                                    <div class="d-flex">
                                        <div class="pe-2 border-end">
                                            <a href="." class="crs default-focus text-nowrap">Sách Trong Nước</a><br>
                                            <a href="." class="crs text-nowrap">FOREIGN BOOKS</a><br>
                                        </div>
                                        <div class="d-flex flex-wrap p-3 text-white" id="categoryContainer" ><!-- Mutable --></div>
                                    </div>
                                </div>
                            </div>&emsp;
                            <input type="text" class="form-control" name="keySearchBook" id="keySearchBook" placeholder="Tìm kiếm sách ở đây...">&emsp;
                            <i class="fa-solid fa-magnifying-glass text-white fa-2x crs" id="searchIcon"></i>
                        </div>
                    </div>
                    <div class="col-lg-3 d-flex align-items-center justify-content-end">
                        <div class="text-center crs">
                            <i class="fa-brands fa-shopify text-white fa-2x d-block"></i>
                            <a href="" class="text-white">Giỏ hàng</a>
                        </div>
                        <div class="text-center mx-2 crs position-relative dropdownContainer" id="accountMutable">
                            <!-- Mutable -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row my-3 mx-5 bg-white">




            <div class="container cart-container">
                <div class="cart-header">
                    <h1>Your Cart</h1>
                    <input type="text" id="searchBar" class="form-control search-bar" placeholder="Search items in your cart...">
                </div>
                
                <table class="table table-bordered table-hover cart-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Image</th>
                            <th>Title</th>
                            <th>Unit Price</th>
                            <th>Quantity</th>
                            <th>Total Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cartItems">
                        <!-- Items will be dynamically inserted here -->
                    </tbody>
                </table>
                
                <div class="position-fixed start-0 bottom-0 p-2 text-white w-100" style="background-color: crimson;">
                    <div class="d-flex">
                        <div class="col-6 text-start">
                            <button class="btn btn-outline-light p-3" id="removeSelected"><i class="far fa-trash-alt"></i> Remove Selected Items</button>
                        </div>
                        <div class="col-6 text-end">
                            <span>Total: <strong id="totalAmount">0</strong> VND</span>
                            <button class="btn btn-light p-3" id="checkoutButton"><i class="fas fa-dollar-sign"></i> Proceed to Checkout</button>
                        </div>
                    </div>
                </div>
            </div>





        </div>
        
        <!-- Footer -->
        <div class="row" style="background-color: crimson;">
            <div class="col-lg-12">
                <div class="d-flex text-white">
                    <div class="col-4 p-2 border-end border-secondary">
                        <img src="./images/ebook-logo.png" alt="ebook-logo-end">
                        <p>✨ ĐỊA CHỈ / CHI NHÁNH: Lầu 5, 387-389 Hai Bà Trưng Quận 3 TP HCMCông Ty Cổ Phần Phát Hành Sách TP HCM - EBOOK60 - 62 Lê Lợi, Quận 1, TP. HCM, Việt Nam <i class="fas fa-map-marker-alt"></i>.</p>
                        <p>✨ Ebook.com nhận đặt hàng trực tuyến và giao hàng tận nơi. KHÔNG hỗ trợ đặt mua và nhận hàng trực tiếp tại văn phòng cũng như tất cả Hệ Thống Ebook trên toàn quốc.</p>
                        <div class="d-flex">
                            ✨&emsp13;
                            <i class="fab fa-facebook-square fa-2x"></i>&emsp;
                            <i class="fab fa-instagram-square fa-2x"></i>&emsp;
                            <i class="fab fa-twitter-square fa-2x"></i>&emsp;
                            <i class="fab fa-youtube-square fa-2x"></i>&emsp;
                            <i class="fab fa-pinterest-p fa-2x"></i>&emsp;
                            <i class="fab fa-tumblr-square fa-2x"></i>
                        </div>
                    </div>
                    <div class="col-6 px-5 pt-5">
                        <img src="https://cdn.pixabay.com/photo/2018/07/12/13/04/copyright-3533368_1280.png" alt="" width="100" height="100" style="float: right;">
                        <span>Giấy chứng nhận Đăng ký Kinh doanh số 0304132047 do Sở Kế hoạch và Đầu tư Thành phố Hồ Chí Minh cấp ngày 20/12/2005, đăng ký thay đổi lần thứ 10, ngày 20/05/2022.</span>
                        <br>
                        <p>- CHĂM SÓC KHÁCH HÀNG: <i class="fas fa-phone-volume"></i> 0338188506</p>
                        <p>- Chịu trách nhiệm và hỗ trợ. Liên hệ:</p>
                        <ul>
                            <li>Hotline: 098 164 0961</li>
                            <li>Email: info@ebook.com</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>





    <div id="modals-container"></div>
    <script src="./js/cart/api.js"></script>
    <script src="./js/cart/util.js"></script>
    <script src="./js/search-book.js"></script>
    <script src="./js/api-get-genres.js"></script>
    <script src="./js/get-alias.js"></script>
    <script src="./js/calculate.js"></script>
    <script src="./js/format.js"></script>
    <script src="./js/logout.js"></script>
    <script>
        var cartItems;
        $(document).ready(async function() {
            // 01. Tải modals
            $.when(
                $.get("./modals/login-modal.html", function(data) {
                    $("#modals-container").append(data);
                }),
                $.get("./modals/register-modal.html", function(data) {
                    $("#modals-container").append(data);
                }),
                $.get("./modals/change-password-modal.html", function(data) {
                    $("#modals-container").append(data);
                }),
                $.get("./modals/user-info-modal.html", function(data) {
                    $("#modals-container").append(data);
                }),
                $.get("./modals/order-detail-modal.html", function(data) {
                    $("#modals-container").append(data);
                })
            ).done(function() {
                console.log("Tất cả các modal đã được tải xong");
            }).fail(function() {
                console.log("Lỗi khi tải modal");
            });
            // 02. Kiểm tra token
            const accessToken = sessionStorage.getItem('user_access_token');
            if (!accessToken) {
                window.location.href = './index.html';
                const noLoginContentHtml = `
                    <i class="fa-regular fa-user text-white fa-2x d-block"></i>
                    <a href="javascript:void(0);" class="text-white">Tài khoản</a>
                    <div class="dropdownContent" style="right: 0;">
                        <div><button class="btn btn-outline-light w-100 rounded-0 mb-1" data-bs-toggle="modal" data-bs-target="#loginModal">Đăng nhập</button></div>
                        <div><button class="btn btn-light w-100 rounded-0" data-bs-toggle="modal" data-bs-target="#registerModal">Đăng ký</button></div>    
                    </div>
                `;
                $("#accountMutable").html(noLoginContentHtml);
            } else {
                $.ajax({
                    url: 'http://localhost:8080/api/v1/user/whoiam',
                    type: 'GET',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
                    },
                    credentials: 'include', // Để gửi cookie trong request
                    success: function(userData) {
                        console.log('response=', userData);
                        // Render data user info modal
                        const htmlContent = `
                            <dt class="col-sm-4">ID:</dt>
                            <dd class="col-sm-8" id="userId">#${userData.id}</dd>

                            <dt class="col-sm-4">Họ:</dt>
                            <dd class="col-sm-8" id="userFirstName">${userData.firstName}</dd>

                            <dt class="col-sm-4">Tên:</dt>
                            <dd class="col-sm-8" id="userLastName">${userData.lastName}</dd>

                            <dt class="col-sm-4">Tên đầy đủ:</dt>
                            <dd class="col-sm-8" id="userFullName">${userData.firstName} ${userData.lastName}</dd>

                            <dt class="col-sm-4">Tên đăng nhập:</dt>
                            <dd class="col-sm-8" id="userName">${userData.username}</dd>

                            <dt class="col-sm-4">Email:</dt>
                            <dd class="col-sm-8" id="userEmail">${userData.email}</dd>

                            <dt class="col-sm-4">Ngày tạo:</dt>
                            <dd class="col-sm-8" id="userCreatedAt">${formatDate(userData.createdAt)}</dd>
                        `;
                        $("#userInfoModalData").html(htmlContent);
                        const loginContentHtml = `
                            <i class="fas fa-user-check text-white fa-2x d-block"></i>
                            <a href="javascript:void(0);" class="text-white">Tài khoản</a>
                            <div class="dropdownContent" style="right: 0;">
                                <div><button class="btn btn-danger w-100 rounded-0 mb-1" data-bs-toggle="modal" data-bs-target="#userInfoModal"><i class="fas fa-info-circle"></i> Xem thông tin</button></div>
                                <div><a href="./order.html" class="btn btn-danger w-100 rounded-0 mb-1"><i class="fas fa-shopping-cart"></i> Đơn mua</a></div>
                                <div><button class="btn btn-danger w-100 rounded-0 mb-1" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-key"></i> Đổi mật khẩu</button></div>
                                <div><button type="button" class="btn btn-danger w-100 rounded-0" onclick="logout('user');"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button></div>
                            </div>
                        `;
                        $("#accountMutable").html(loginContentHtml);
    ;                },
                    error: function(xhr, status, error) {
                        toastr.error('http://localhost:8080/api/v1/users/whoiam error.');
                    }
                });
            }
            // 03. Tải genres menu
            const categoryContainer = $("#categoryContainer");
            categoryContainer.html("");
            const mygenres = await getGenres();
            for (const [group, genres] of Object.entries(mygenres)) {
                const groupName = genreGroupTranslations[group] || group;
                const limitedGenres = genres.slice(0, 5);
                let genreItems = limitedGenres.map(genre => {
                    const translatedGenre = genreTranslations[genre] || genre.replace(/_/g, ' ');
                    return `<span class="d-block crs" onclick="window.location.href = './search.html?key=${encodeURIComponent(genre)}';">${translatedGenre}</span>`;
                }).join('');
                genreItems += '<span class="d-block crs text-decoration-underline">Xem tất cả</span>';

                const columnHtml = `
                    <div class="col-3 p-2 mb-1 small">
                        <span class="d-block fw-bold mb-2 text-truncate fs-6">${groupName}</span>
                        ${genreItems}
                    </div>
                `;
                categoryContainer.append(columnHtml);
            }
            // 04. Genre hover change
            $('.dropdownContent a').on('mouseover', async function() {
                $('.default-focus').removeClass('default-focus');
                $(this).addClass('default-focus');

                const mygenres = await getGenres();
                const category = $(this).text().trim();
                const $container = $('#categoryContainer');
                $container.empty(); // Xóa nội dung hiện tại trong container

                switch (category) {
                    case "Sách Trong Nước":
                        $.each(mygenres, function(group, genres) {
                            const groupName = genreGroupTranslations[group] || group;
                            const limitedGenres = genres.slice(0, 5);
                            let genreItems = limitedGenres.map(genre => {
                                const translatedGenre = genreTranslations[genre] || genre.replace(/_/g, ' ');
                                return `<span class="d-block crs" onclick="window.location.href = './search.html?key=${encodeURIComponent(genre)}';">${translatedGenre}</span>`;
                            }).join('');
                            genreItems += '<span class="d-block crs text-decoration-underline">Xem tất cả</span>';

                            const columnHtml = `
                                <div class="col-3 p-2 mb-1 small">
                                    <span class="d-block fw-bold mb-2 text-truncate fs-6">${groupName}</span>
                                    ${genreItems}
                                </div>
                            `;
                            $container.append(columnHtml);
                        });
                        break;

                    case "FOREIGN BOOKS":
                        $.each(mygenres, function(group, genres) {
                            const groupName = group;
                            const limitedGenres = genres.slice(0, 5);
                            let genreItems = limitedGenres.map(genre => `<span class="d-block crs" onclick="window.location.href = './search.html?key=${encodeURIComponent(genre)}';">${genre.replace(/_/g, ' ')}</span>`).join('');
                            genreItems += '<span class="d-block crs text-decoration-underline">Xem tất cả</span>';

                            const columnHtml = `
                                <div class="col-3 p-2 mb-1 small">
                                    <span class="d-block fw-bold mb-2 text-truncate fs-6">${groupName}</span>
                                    ${genreItems}
                                </div>
                            `;
                            $container.append(columnHtml);
                        });
                        break;

                    default:
                        break;
                }
            });
            // 05. Keywork Tìm kiếm book
            $('#searchIcon').on('click', function() {
                searchBooks();
            });
            $('#keySearchBook').on('keypress', function(e) {
                if (e.which == 13) { // Enter key pressed
                    searchBooks();
                }
            });

            cartItems = await getUserCartItems();
            renderCartItems();

            // 06. Listener
            $('#selectAll').click(function () {
                $('.item-check').prop('checked', this.checked);
                calculateTotalAmount();
            });
            $(document).on('change', '.item-check', function () {
                calculateTotalAmount();
            });
            $('#removeSelected').click(function () {
                const selectedCartItemIds = [];
                $('.item-check:checked').each(function () {
                    selectedCartItemIds.push($(this).closest('tr').find('.remove-item').data('id'));
                });
                const accessToken = sessionStorage.getItem('user_access_token');
                $.ajax({
                    url: 'http://localhost:8080/api/v1/cart/cartItem/deleteMany',
                    type: 'DELETE',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
                    },
                    contentType: 'application/json',
                    data: JSON.stringify(selectedCartItemIds),
                    success: function(response) {
                        toastr.success('Selected cart items deleted successfully.');
                        cartItems = cartItems.filter(item => !selectedCartItemIds.includes(item.cartItem.id));
                    },
                    error: function(xhr, status, error) {
                        if (xhr.status === 404) {
                            toastr.error(xhr.responseText);
                        } else {
                            toastr.error('An error occurred. Please try again.');
                        }
                    }, complete: function() {
                        renderCartItems();
                calculateTotalAmount();
                    }
                });
            });
            $(document).on('click', '.remove-item', function () {
                const cartItemId = $(this).data('id');
                const accessToken = sessionStorage.getItem('user_access_token');
                $.ajax({
                    url: `http://localhost:8080/api/v1/cart/cartItem/${cartItemId}`,
                    method: 'DELETE',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
                    },
                    credentials: 'include',
                    success: function(response) {
                        toastr.success('Cart item delete successfully.');
                        cartItems = cartItems.filter(item => item.cartItem.id !== cartItemId);
                    },
                    error: function(xhr, status, error) {
                        toastr.error('An error occurred. Please try again.', xhr.responseText, 'Error!');
                    }, complete: function() {
                        renderCartItems();
                        calculateTotalAmount();
                    }
                });
            });
            $(document).on('change', '.quantity-input', function () {
                const cartItemId = $(this).data('id');//
                const newQuantity = Number($(this).val());
                const accessToken = sessionStorage.getItem('user_access_token');
                $.ajax({
                    url: `http://localhost:8080/api/v1/cart/cartItem/${cartItemId}?quantity=${newQuantity}`,
                    method: 'PATCH',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
                    },
                    credentials: 'include',
                    success: function(response) {
                        toastr.success('Cart item updated successfully.');
                        cartItems.forEach(item => {
                            if (item.cartItem.id === cartItemId) {
                                item.cartItem.quantity = newQuantity;
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        if (xhr.status === 400) {
                            toastr.error(xhr.responseText);
                        } else if (xhr.status === 404) {
                            toastr.error('Cart item not found.');
                        } else {
                            toastr.error('An error occurred. Please try again.');
                        }
                    }, complete: function() {
                        renderCartItems();
                        calculateTotalAmount();
                    }
                });
            });
            $('#searchBar').on('input', function () {
                const query = $(this).val().toLowerCase();
                $('#cartItems tr').each(function () {
                    const title = $(this).find('td:nth-child(3)').text().toLowerCase();
                    $(this).toggle(title.includes(query));
                });
            });
            // Checkout button click
            $('#checkoutButton').click(function () {
                const selectedBookIds = [];
                const selectedQuantities = [];
                const selectedCartItemIds = [];
                $('.item-check:checked').each(function () {
                    selectedBookIds.push($(this).data('book-id'));
                    selectedQuantities.push($(this).data('quantity'));
                    selectedCartItemIds.push($(this).data('id'));
                });
                console.log("Selected book IDs for checkout:", selectedBookIds);
                console.log("Selected book Quantities for checkout:", selectedQuantities);
                console.log("Selected cartItem IDs for checkout:", selectedCartItemIds);
                // Make an API call or handle the checkout process here with the selectedBookIds
                window.location.href = `./payment.html?bookIds=${selectedBookIds.toString()}&quantities=${selectedQuantities.toString()}&cartItemIds=${selectedCartItemIds.toString()}`
            });
        });    
    </script>
</body>
</html>